import*as e from"@joskii/jflow-core";import t,{TextGroup as n}from"@joskii/jflow-core";var s={provide(){return{addToStack:this.addToStack,removeFromStack:this.removeFromStack}},data:()=>({stack:[]}),methods:{addToStack(e,t){this._jflowInstance.addToStack(e),t&&e._jflow.setRenderNodeBySource(t,e)},removeFromStack(e){this._jflowInstance.removeFromStack(e)},onStackChangeHandler(){this._jflowInstance.recalculate(),this._jflowInstance.reflow()}}},o={mixins:[s],provide(){return{renderJFlow:this.renderJFlow,getJFlow:this.getInstance,addToLinkStack:this.addToLinkStack,removeFromLinkStack:this.removeFromLinkStack}},props:{configs:{type:Object,default:function(){return{}}},loading:Boolean,genVueComponentKey:{type:Function}},data:()=>({renderNodes:[],renderLinks:[]}),render:function(e){if(this.renderNodes.length){return e("div",[...this.renderNodes.map((({type:e,source:t,layoutNode:n})=>{if(!this.$scopedSlots[e]){if(!this.$scopedSlots.jflowcommon)return null;e="jflowcommon"}if(n.__vnode__)return n.__vnode__;const[s]=this.$scopedSlots[e]({source:t,layoutNode:n});return this.genVueComponentKey&&(s.key=this.genVueComponentKey(t)),n.__vnode__=s,s})).filter((e=>!!e)),...this.renderLinks.map((e=>{let t=e.type||"plainlink";if(!this.$scopedSlots[t])return null;if(e.__vnode__)return e.__vnode__;const[n]=this.$scopedSlots[t]({configs:e});if(this.genVueComponentKey){const t=this.genVueComponentKey(e.from.source),s=this.genVueComponentKey(e.to.source),o=e.part;n.key=`${t}-${s}-${o}`}return e.__vnode__=n,n}))])}return e("div",this.$slots.default)},created(){this._jflowInstance=new t(this.configs),this.$emit("update:loading",!0),this.genNodeLinkMeta(),this.syncNodeLink()},mounted(){this.mountJFlow()},beforeDestroy(){this._jflowInstance?.destroy()},methods:{mountJFlow(){this._jflowInstance.$mount(this.$el),Object.keys(this.$listeners).map((e=>{const t=this.$listeners[e].bind(this);this._jflowInstance.addEventListener(e,t)})),this.$emit("update:loading",!1)},genNodeLinkMeta(){this.nodes=this._jflowInstance._layout.flowStack.map((e=>{const{type:t,layoutNode:n,source:s}=e,o=this._jflowInstance.source_Layout_Render_NodeMap;let i;return i=o.has(s)?o.get(s):o.set(s),i.layoutNode=n,e})),this.links=this._jflowInstance._layout.flowLinkStack.slice()},syncNodeLink(){this.renderNodes=this.nodes.slice(),this.renderLinks=this.links.slice()},reflow(e,t){this.genNodeLinkMeta(),this.syncNodeLink(),this.$nextTick((()=>{e&&e(),this._jflowInstance.recalculate(),this._jflowInstance.scheduleRender((()=>{t&&t()}))}))},getInstance(){return this._jflowInstance},renderJFlow(){this.__renderInSchedule__||(this.__renderInSchedule__=!0,this.$nextTick((()=>{this._jflowInstance._render(),this.__renderInSchedule__=!1})))},addToLinkStack(e,t,n){this._jflowInstance.addToLinkStack(e),t&&n&&e._jflow.addLinkNodeBySource(t,n,e)},removeFromLinkStack(e,t,n){this._jflowInstance.removeFromLinkStack(e),t&&n&&e._jflow.removeLinkNodeBySource(t,n,e)}}};function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function r(){return c(null,[].slice.call(arguments,0))}function c(e,t){for(var n,s,o,i,r,c=t.length,l=t[0],h={},d=e&&e.equal||a,f=1;f<c;f++)for(n=t[f],o=(s=Object.keys(n)).length,r=0;r<o;r++)d(n[i=s[r]],l[i])||(h[i]=n[i]);return h}function a(e,t){return e===t}r.custom=function(e){return c(e,[].slice.call(arguments,1))};var l=i(r);function h(t){const n="string"==typeof t?e[t]:t;return{inject:["addToStack","removeFromStack"],props:{configs:{type:Object,default:function(){return{}}},visible:{type:Boolean,default:!0},source:{type:Object}},watch:{configs(e,t){const n=l(e,t);0!==Object.keys(n).length&&this._jflowInstance.setConfig(e)},$listeners(e,t){let n=[],s=[];const o=Object.keys(e).map((t=>({event:t,handler:e[t]}))),i=Object.keys(t).map((e=>({event:e,handler:t[e]})));o.forEach((e=>{const t=e.handler;i.find((e=>e.handler===t))||n.push(e)})),i.forEach((e=>{const t=e.handler;o.find((e=>e.handler===t))||s.push(e)})),n.forEach((e=>{this._jflowInstance.addEventListener(e.event,e.handler)})),s.forEach((e=>{this._jflowInstance.removeEventListener(e.event,e.handler)}))},visible(e){this._jflowInstance.visible=e},source(e){this._jflowInstance._jflow.setRenderNodeBySource(e,this._jflowInstance)}},render:function(e){return null},created(){this._jflowInstance=new n(this.configs),this._jflowInstance.visible=this.visible,this.bindListeners(),this.addToStack(this._jflowInstance,this.source)},destroyed(){this._jflowInstance.destroy(),this.removeFromStack(this._jflowInstance)},methods:{bindListeners(){Object.keys(this.$listeners).map((e=>{const t=this.$listeners[e];this._jflowInstance.addEventListener(e,t)}))}}}}function d(t){const n="string"==typeof t?e[t]:t;return{inject:["addToLinkStack","removeFromLinkStack","getJFlow"],props:{configs:{type:Object,default:function(){return{}}},from:Object,to:Object},render:function(e){return null},created(){const e=this.getJFlow(),t=e.getRenderNodeBySource(this.from),n=e.getRenderNodeBySource(this.to);this.createInstance(t,n)},mounted(){this.unwatch=this.$watch((()=>[this.from,this.to,this.configs]),(()=>{this.refreshConfig()}))},methods:{createInstance(e,t){e&&t&&(this._jflowInstance=new n({...this.configs,from:e,to:t}),this.bindListeners(),this.addToLinkStack(this._jflowInstance,this.from,this.to))},refreshConfig(){const e=this.getJFlow(),t=e.getRenderNodeBySource(this.from),n=e.getRenderNodeBySource(this.to);this._jflowInstance?this._jflowInstance.setConfig({...this.configs,from:t,to:n}):this.createInstance(t,n)},bindListeners(){Object.keys(this.$listeners).map((e=>{const t=this.$listeners[e];this._jflowInstance.addEventListener(e,t)}))}},destroyed(){this.unwatch(),this._jflowInstance&&this.removeFromLinkStack(this._jflowInstance,this.from,this.to)}}}function f(t){const n="string"==typeof t?e[t]:t;return{mixins:[s],inject:{addToBelongStack:{from:"addToStack"},removeFromBelongStack:{from:"removeFromStack"},renderJFlow:{from:"renderJFlow"}},render:function(e){return e("jflow-group",this.$slots.default)},props:{configs:{type:Object,default:function(){return{}}},visible:{type:Boolean,default:!0},source:{type:Object}},watch:{configs(e,t){JSON.stringify(e)!==JSON.stringify(t)&&this._jflowInstance.setConfig(e)},$listeners(e,t){let n=[],s=[];const o=Object.keys(e).map((t=>({event:t,handler:e[t]}))),i=Object.keys(t).map((e=>({event:e,handler:t[e]})));o.forEach((e=>{const t=e.handler;i.find((e=>e.handler===t))||n.push(e)})),i.forEach((e=>{const t=e.handler;o.find((e=>e.handler===t))||s.push(e)})),n.forEach((e=>{this._jflowInstance.addEventListener(e.event,e.handler)})),s.forEach((e=>{this._jflowInstance.removeEventListener(e.event,e.handler)}))},visible(e){this._jflowInstance.visible=e},source(e){this._jflowInstance._jflow.setRenderNodeBySource(e,this._jflowInstance)}},created(){this._jflowInstance=new n(this.configs),this._jflowInstance.visible=this.visible,Object.keys(this.$listeners).map((e=>{const t=this.$listeners[e].bind(this);this._jflowInstance.addEventListener(e,t)})),this.addToBelongStack(this._jflowInstance,this.source)},mounted(){this._jflowInstance.recalculate()},updated(){this._jflowInstance.recalculateUp()},destroyed(){this._jflowInstance.destroy(),this.removeFromBelongStack(this._jflowInstance)}}}var u={mixins:[s],inject:{addToBelongStack:{from:"addToStack"},removeFromBelongStack:{from:"removeFromStack"},renderJFlow:{from:"renderJFlow"}},data:()=>({nodes:[]}),props:{configs:{type:Object,default:function(){return{}}},visible:{type:Boolean,default:!0},source:{type:Object},genVueComponentKey:{type:Function}},watch:{configs(e,t){JSON.stringify(e)!==JSON.stringify(t)&&this._jflowInstance.setConfig(e)},$listeners(e,t){let n=[],s=[];const o=Object.keys(e).map((t=>({event:t,handler:e[t]}))),i=Object.keys(t).map((e=>({event:e,handler:t[e]})));o.forEach((e=>{const t=e.handler;i.find((e=>e.handler===t))||n.push(e)})),i.forEach((e=>{const t=e.handler;o.find((e=>e.handler===t))||s.push(e)})),n.forEach((e=>{this._jflowInstance.addEventListener(e.event,e.handler)})),s.forEach((e=>{this._jflowInstance.removeEventListener(e.event,e.handler)}))},visible(e){this._jflowInstance.visible=e},source(e){this._jflowInstance._jflow.setRenderNodeBySource(e,this._jflowInstance)}},created(){this._jflowInstance=new n(this.configs),this._jflowInstance.visible=this.visible,Object.keys(this.$listeners).map((e=>{const t=this.$listeners[e].bind(this);this._jflowInstance.addEventListener(e,t)})),this.addToBelongStack(this._jflowInstance,this.source),this.genTextElementMeta()},mounted(){this._jflowInstance.recalculate()},updated(){this._jflowInstance.recalculateUp()},destroyed(){this._jflowInstance.destroy(),this.removeFromBelongStack(this._jflowInstance)},render:function(e){if(this.nodes.length){return e("div",this.nodes.map((e=>{let{type:t,source:n}=e;if(!this.$scopedSlots[t]){if(!this.$scopedSlots.jflowcommon)return;t="jflowcommon"}if(e.__vnode__)return e.__vnode__;const[s]=this.$scopedSlots[t]({source:n,textElement:e});return this.genVueComponentKey&&(s.key=this.genVueComponentKey(n)),e.__vnode__=s,s})))}return e("jflow-group",this.$slots.default)},methods:{genTextElementMeta(){this.nodes=this._jflowInstance._flattenTxtElem.filter((e=>"text"!==e.type))},reflow(){this._jflowInstance.refreshTextElements(),this.genTextElementMeta(),this.$nextTick((()=>{this._jflowInstance.refresh()}))}}};function m(e){return{mixins:[s],inject:{addToBelongStack:{from:"addToStack"},removeFromBelongStack:{from:"removeFromStack"},renderJFlow:{from:"renderJFlow"}},render:function(e){const t=this.renderLinks.map((e=>{let t=e.type||"plainlink";if(!this.$scopedSlots[t])return null;if(e.__vnode__)return e.__vnode__;const[n]=this.$scopedSlots[t]({configs:e});if(this.genVueComponentKey){const t=this.genVueComponentKey(e.from.source),s=this.genVueComponentKey(e.to.source),o=e.part;n.key=`${t}-${s}-${o}`}return e.__vnode__=n,n}));return e("jflow-group",[...this.$slots.default,...t])},props:{configs:{type:Object,default:function(){return{}}},visible:{type:Boolean,default:!0},source:{type:Object}},data:()=>({renderLinks:[]}),watch:{configs(e,t){JSON.stringify(e)!==JSON.stringify(t)&&this._jflowInstance.setConfig(e)},$listeners(e,t){let n=[],s=[];const o=Object.keys(e).map((t=>({event:t,handler:e[t]}))),i=Object.keys(t).map((e=>({event:e,handler:t[e]})));o.forEach((e=>{const t=e.handler;i.find((e=>e.handler===t))||n.push(e)})),i.forEach((e=>{const t=e.handler;o.find((e=>e.handler===t))||s.push(e)})),n.forEach((e=>{this._jflowInstance.addEventListener(e.event,e.handler)})),s.forEach((e=>{this._jflowInstance.removeEventListener(e.event,e.handler)}))},visible(e){this._jflowInstance.visible=e},source(e){this._jflowInstance._jflow.setRenderNodeBySource(e,this._jflowInstance)}},created(){this._jflowInstance=new e(this.configs),this._jflowInstance.visible=this.visible,Object.keys(this.$listeners).map((e=>{const t=this.$listeners[e].bind(this);this._jflowInstance.addEventListener(e,t)})),this.addToBelongStack(this._jflowInstance,this.source),this.genLinks()},mounted(){this._jflowInstance.recalculate()},updated(){this._jflowInstance.recalculateUp()},destroyed(){this._jflowInstance.destroy(),this.removeFromBelongStack(this._jflowInstance)},methods:{genLinks(){this.renderLinks=this._jflowInstance._layout.flowLinkStack.slice()}}}}const _=[{name:"Jflow",component:o},{name:"Group",component:f("Group")},...["CapsuleGroup","CapsuleVerticalGroup","DiamondGroup","DiamondVerticalGroup","RhombusGroup","PointGroup","ScrollGroup"].map((e=>({name:e,component:f(e)}))),...["Point","Rectangle","Capsule","Diamond","Rhombus","Text","Icon","ShadowDom","TextEditor"].map((e=>({name:e,component:h(e)}))),...["Link","PolyLink","BezierLink"].map((e=>({name:e,component:d(e)}))),{name:"TextGroup",component:u}];customElements.define("jflow-group",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}});const p={install:(e,t={})=>{let n="j";t&&t.prefix&&(n=t.prefix),_.forEach((t=>{e.component(`${n}${t.name}`,t.component)})),t.customInstance&&Object.keys(t.customInstance).forEach((s=>{e.component(`${n}${s}`,h(t.customInstance[s]))})),t.customGroups&&Object.keys(t.customGroups).forEach((s=>{e.component(`${n}${s}`,f(t.customGroups[s]))})),t.customLink&&Object.keys(t.customLink).forEach((s=>{e.component(`${n}${s}`,d(t.customLink[s]))}))}};export{m as JFlowLinkGroup,p as JFlowVuePlugin};
//# sourceMappingURL=jflow-vue2-plugin.es.min.js.map
